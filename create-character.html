<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Character</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            background: gray;
            color: white;
            text-align: center;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: auto;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
        }
        input, textarea, button {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            max-width: 100%;
        }
        input {
            background: #333;
            color: white;
        }
        button {
            background: #ff6600;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover {
            background: #ff4500;
        }
        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .tag {
            background: #ff6600;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .tag:hover {
            background: #ff4500;
        }
        .back-btn {
            display: inline-block;
            background: #ff6600;
            color: white;
            padding: 10px 20px;
            margin: 20px;
            font-size: 18px;
            border-radius: 5px;
            text-decoration: none;
        }
        .description-input {
            width: 100%;
            min-height: 50px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: none;
            resize: none;
            background: #333;
            color: white;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Create a New Character</h1>
        <form id="characterForm">
            <input type="file" id="imageUpload" accept="image/*">
            <img id="previewImage" style="display: none; width: 200px;" />
            <input type="text" id="characterName" placeholder="Character Name" required>
            <textarea id="charDescription" class="description-input" placeholder="Character Description" cols="40" rows="5" required></textarea>
            <div class="tags" id="tagContainer"></div>
            <input type="text" id="tagInput" placeholder="Press Enter after each Tag">
            <button type="submit">Create Character</button>
        </form>
        <a href="index.html" class="back-btn">Back</a>
    </div>

<script type="module">
    let uploadedImageUrl = ""; // Variable to store the uploaded image URL
    document.getElementById("imageUpload").addEventListener("change", function(event) {
        const file = event.target.files[0];
        if (!file) return;
    
            //  Read as ArrayBuffer for metadata extraction
            const reader1 = new FileReader();
            reader1.onload = function(e) {
                parsePNGMetadata(e.target.result);
            };
            reader1.readAsArrayBuffer(file);

            // Read as DataURL for previewing the image
            const reader2 = new FileReader();
            reader2.onload = function(e) {
                document.getElementById("previewImage").src = e.target.result;
                document.getElementById("previewImage").style.display = "block";
            };
            reader2.readAsDataURL(file);

            // Upload to Imgur automatically
            const formData = new FormData();
            formData.append("image", file);
    
        fetch("https://api.imgur.com/3/image", {
            method: "POST",
            headers: {
                "Authorization": "Client-ID e5878f258cd03cf" // Replace with your Client ID
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 3️⃣ Replace local preview with uploaded image URL
                document.getElementById("previewImage").src = data.data.link;
                uploadedImageUrl = data.data.link; // Store Imgur URL in variable
            } else {
                alert("Upload failed!");
            }
        })
        .catch(error => console.error("Error:", error));
    });


        
    document.getElementById("characterForm").addEventListener("submit", async function(event) {
        event.preventDefault();      
        var name = document.getElementById("characterName").value;
        var description = document.getElementById("charDescription").value;
        var tags = Array.from(document.querySelectorAll("#tagContainer .tag"))
                 .map(tag => tag.textContent)
                 .join(", ");
        
        var image = uploadedImageUrl
        
        var data = {
             "username": name,
             "avatar_url": image, // Extract image source
             "content": description, // Extract text content
             "embeds": [
             {
               "title": "new character",
               "description": image,
               "color": 16711680,
               "fields": [
               {
                 "name": "Tag 1",
                 "value": tags,
                 "inline": true
               },
               ]
             }
             ],
         };

         fetch("https://discord.com/api/webhooks/1348278406416175215/n0mDSPFAHf47EsBfR7kley-sW7nJWD_UeZ94GNbNyCnvzMr45pOLw8mHSnwqjmxCDjnu", {
             method: "POST",
             headers: {
                 "Content-Type": "application/json"
             },
             body: JSON.stringify(data)
         })
         .then(response => {
             if (response.status === 204) {
                 console.log("Success: Message sent (204 No Content)");
                 alert("Character created successfully!");
                 return {}; // Return empty object to keep .json() format
             }
             return response.json(); // Parse only if there's content
         })
         .then(data => console.log("Success:", data))
         .catch(error => console.error("Error:", error));
     });

    function parsePNGMetadata(arrayBuffer) {
        const dataView = new DataView(arrayBuffer);
        let offset = 8; // PNG header size
        
        while (offset < dataView.byteLength) {
            let chunkLength = dataView.getUint32(offset);
            let chunkType = new TextDecoder().decode(new Uint8Array(arrayBuffer, offset + 4, 4));

            if (chunkType === "tEXt") {  // Metadata chunk
                let chunkData = new Uint8Array(arrayBuffer, offset + 8, chunkLength);
                let textData = new TextDecoder().decode(chunkData);

                if (textData.startsWith("chara")) { 
                    let base64Data = textData.split("\u0000")[1]; // Extract after null separator
                    decodeBase64JSON(base64Data);
                    return;
                }
            }
            offset += 12 + chunkLength;
        }
        document.getElementById("charDescription").textContent = "Not a tavern card.";
    }

    function decodeBase64JSON(base64Str) {
        try {
            let jsonString = atob(base64Str);
            let jsonData = JSON.parse(jsonString);
            document.getElementById("charDescription").textContent = JSON.stringify(jsonData, null, 4);

            // Enable download button
            const downloadBtn = document.getElementById("downloadJson");
            downloadBtn.style.display = "block";
            downloadBtn.onclick = () => downloadJSON(jsonData);
        } catch (e) {
            document.getElementById("charDescription").textContent = "Error decoding metadata.";
        }
    }

    document.getElementById("tagInput").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            const tagText = this.value.trim();
            if (tagText) {
                const tag = document.createElement("span");
                tag.classList.add("tag");
                tag.textContent = tagText;
                tag.addEventListener("click", function() {
                    this.remove();
                });
                document.getElementById("tagContainer").appendChild(tag);
                this.value = "";
            }
        }
    });

    document.getElementById("charDescription").addEventListener("input", function() {
        this.style.height = "auto";
        this.style.height = (this.scrollHeight) + "px";
    });
</script>

</body>
</html>
