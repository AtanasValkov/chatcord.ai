<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <h1><img src="/mascots.png" alt="Logo" class="logo"> ChatCord</h1>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="/favicon.ico">
</head>
<body>
    <header>
        <div class="header">
            <img src="/mascots.png" alt="ChatCord Logo" class="logo">
            <h1 class="title">ChatCord</h1>
        </div>
        <button class="header-toggle" id="headerToggle">☰</button>
        <nav>
            <a title="Click to go to character creator" id="createCharacterButton" href="#">Create-A-Character</a>
            <a title="Click to go to character creator" id="worldbooksButton" href="#">Worldbooks</a>
            <a title="Click to go to profile page" id="profileButton" href="#">Guest</a>
            <a title="Click to go to settings page" id="settingsButton" href="#">Settings</a>
            <a href="https://chatcord-server.onrender.com/login" id="loginButton">Login</a>
            <a href="https://discord.gg/ZKRcZA7a3E" target="_blank">
                <img src="https://img.shields.io/badge/Join%20Discord-5865F2?style=for-the-badge&logo=discord&logoColor=white" 
                     alt="Join ChatCord">
            </a>

        </nav>
    </header>
        <div id="detailsPanelPlace">
        </div>
        <!-- Modal Settings Window -->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
              <span id="closeModal" class="close">&times;</span>
              <h2>Settings</h2>
              
              <!-- Change Username -->
              <section>
                <h3>Username</h3>
                <input type="text" id="usernameInput" placeholder="Enter new username" />
                <button id="saveUsername">Save</button>
              </section>
              
              <!-- Account Deletion -->
              <section>
                <h3>Account</h3>
                <button id="deleteAccount" class="danger">Delete Account</button>
              </section>
              
              <!-- Tag Preferences -->
              <section>
                <h3>Tag Preferences</h3>
                <div id="tagSettings">
                    <!-- Toggle Button -->
                    <button id="toggleTagPrefsBtn">Edit Tag Preferences</button>
                    
                    <!-- Collapsible Tag Preferences Section -->
                    <div id="tagPrefsSection" class="hidden">
                      <input type="text" id="searchBarSettings" placeholder="Search..." class="search-bar">
                      <ul class="tag-list">
                         <!-- Tags will be populated here -->
                       </ul>
                    </div>
                </div>
              </section>
              
              <!-- Theme Toggle -->
                <section>
                    <h3>Theme</h3>
                    <button id="themeToggle" class="icon-button">
                    <i id="themeIcon" class="fas fa-moon"></i>
                    </button>
                </section>

                  <!-- Guilds -->
                <section>
                    <h3>Select Favorite Guild</h3>
                    <select id="favoriteGuild">
                        <option value="">None</option>
                        <!-- Populate with guilds -->
                    </select>
                </section>

              <!-- Openrouter key -->
                <section>
                    <h3>Free AI access</h3>
                    <button id="openrouterKey"> API Key </button>
                    <div id="openrouterKeyMessage"></div>
                </section>
            </div>
        </div>
    
        <!-- Bot Modal -->
        <div id="modal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Load Character</h2>
        
                <div>
                    <label for="guild-select">Select Server</label>
                    <select id="guild-select">
                        <option value="">Select a Server</option>
                    </select>
                </div>
        
                <div>
                    <label for="channel-select">Select Channel</label>
                    <select id="channel-select" disabled>
                        <option value="">Select a Channel</option>
                    </select>
                </div>
                <div>
                    <button id="create-webhook-btn" disabled>Load Character</button>
                    <button id="refresh-guilds">Refresh Servers</button>
                    <button id="force-refresh-channels" disabled>Refresh Channels</button>
                </div>
            </div>
        </div>

    <div class="container">
        <aside class="sidebar">
            <input type="text" id="searchBar" placeholder="Search..." class="search-bar">
            <h2>Tags</h2>
            <ul id="tagFilters"></ul>
        </aside>

        <main>
                <div class="sort-controls">
                    <div class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </div>
                  <select id="sortOptions">
                    <option value="downloads">Downloads</option>
                    <option value="likes">Likes</option>
                    <option value="comments">Comments</option>
                    <option value="favorites">Favorites</option>
                    <option value="date">Date Created</option>
                  </select>
                  <select id="sortOrder">
                    <option value="desc">Descending</option>
                    <option value="asc">Ascending</option>
                  </select>
                  <input type="text" id="searchBarCharacters" placeholder="Search..." />
                </div>
                <!-- Recommended Characters Section -->
                <div class="character-section" id="recsSection">
                  <div class="section-header">
                    <h2 class="section-title">Recommended</h2>
                    <div class="section-controls">
                      <button id="recsToggleBtn" class="toggle-btn" aria-expanded="true" title="Collapse section">
                        <span class="icon" aria-hidden="true">▾</span>
                        <span class="sr-only">Toggle Recommended</span>
                      </button>
                    </div>
                  </div>
                
                  <div class="character-grid" id="recsCharacterGrid">
                    Loading recommended characters...
                  </div>
                </div>
                
                <!-- Main Characters Section -->
                <div class="character-section">
                  <h2 class="section-title">All Characters</h2>
                  <div class="character-grid" id="characterGrid">
                    Loading characters...Check back in 1 to 2 minutes.
                  </div>
                </div>
                    <script type="module">
                        import { populateGrid, fetchGuilds } from './characterGrid.js';

                        const RECS_SECTION_ID = 'recsSection';
                        const RECS_TOGGLE_ID = 'recsToggleBtn';
                        const RECS_MINIMIZED_KEY = 'recsSectionMinimized'; // localStorage key
                        
                        const recsSection = document.getElementById(RECS_SECTION_ID);
                        const recsToggleBtn = document.getElementById(RECS_TOGGLE_ID);
                        const searchInput = document.getElementById('searchBarCharacters');

                        let allCharacters = []; // cached data
                        let lastFetchTime = 0;
                        
                        // helper to set collapse state and persist
                        function setRecsSectionMinimized(minimized, persist = true) {
                          if (!recsSection || !recsToggleBtn) return;
                          recsSection.classList.toggle('minimized', !!minimized);
                          recsToggleBtn.setAttribute('aria-expanded', String(!minimized));
                          recsToggleBtn.title = minimized ? 'Expand section' : 'Collapse section';
                          if (persist) {
                            try { localStorage.setItem(RECS_MINIMIZED_KEY, minimized ? '1' : '0'); } catch (e) { /* ignore */ }
                          }
                        }
                        
                        // initialize from saved preference (user-controlled)
                        function initRecsSectionState() {
                          if (!recsSection || !recsToggleBtn) return;
                          let saved = null;
                          try { saved = localStorage.getItem(RECS_MINIMIZED_KEY); } catch (e) { /* ignore */ }
                          if (saved === '1') setRecsSectionMinimized(true, false);
                          else setRecsSectionMinimized(false, false);
                        }
                        
                        if (recsToggleBtn && recsSection) {
                          recsToggleBtn.addEventListener('click', () => {
                            const isMin = recsSection.classList.contains('minimized');
                            setRecsSectionMinimized(!isMin, true); // toggle and persist
                          });
                        }
                        
                        // call this during initialization so UI respects stored preference
                        initRecsSectionState();

                        async function fetchCharactersFromServer(forceRefresh = false) {
                          // optional: refresh cache every 15 minutes
                          const now = Date.now();
                          if (!forceRefresh && allCharacters.length > 0 && (now - lastFetchTime) < 15 * 60 * 1000) {
                            return allCharacters;
                          }
                        
                          console.log("Fetching characters from server...");
                          const response = await fetch('https://chatcord-server.onrender.com/get-characters');
                          const characters = await response.json();
                        
                          if (characters.error) {
                            console.error('Error:', characters.error);
                            return [];
                          }
                        
                          allCharacters = Array.isArray(characters) ? characters : Object.values(characters);
                          lastFetchTime = now;
                          return allCharacters;
                        }

                        async function verifyUser() {
                            // Extract 'code' from the URL
                            const urlParams = new URLSearchParams(window.location.search);
                            const code = urlParams.get("code");
                            const user = JSON.parse(localStorage.getItem("user"));            
                            //const provider = urlParams.get("provider");
                            if (user) {
                               let endpoint = "";
                            
                               if (code) {
                                   endpoint = `https://chatcord-server.onrender.com/openrouter-callback?code=${code}&user_id=${user.id}`;
                               }
                            
                                if (endpoint) {
                                    fetch(endpoint, {
                                        method: "GET",
                                        mode: "cors",
                                        credentials: "include"
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        // Get the message from the response data
                                        const message = data.message || "API key updated successfully";
                                        // Display the message in the message div
                                        document.getElementById("openrouterKeyMessage").textContent = message;
                                    })
                                    .catch(error => {
                                        console.error("Auth error:", error);
                                        // Display an error message in the message div
                                        document.getElementById("openrouterKeyMessage").textContent = "An error occurred while updating the API key.";
                                    });
                                }

                                document.getElementById("loginButton").textContent = "Logout";
                                document.getElementById("loginButton").href = "#";
                                document.getElementById("loginButton").onclick = logout;
                            
                                const profileButton = document.getElementById("profileButton");
                                profileButton.innerHTML = ""; // Clear previous content
                            
                                // Create a span for the username
                                const usernameSpan = document.createElement("span");
                                name = "";
                                if (user.displayname) {
                                    name = user.displayname;
                                }
                                else {
                                    name = user.username;
                                }
                                usernameSpan.textContent = name;
                            
                                // Create an avatar image
                                const avatarIcon = document.createElement("img");
                                avatarIcon.src = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;
                                avatarIcon.alt = "Avatar";
                            
                                // Append both elements to the profile button
                                profileButton.appendChild(usernameSpan);
                                profileButton.appendChild(avatarIcon);

                                // Load Settings
                                loadSettings();
                                if (code) {  
                                    window.history.replaceState({}, document.title, "index.html");
                                }
                                
                            }
                            else if (code) {
                                // Send 'code' to Flask backend
                                fetch("https://chatcord-server.onrender.com/callback?code=" + code, {
                                    method: "GET",
                                    mode: "cors",
                                    credentials: "include"  // If using Flask sessions
                                })
                                .then(response => response.json())
                                .then(data => {
                                    console.log("User data:", data);
                                    if (data.user) {
                                        // Store user data in localStorage
                                        localStorage.setItem("user", JSON.stringify(data.user));
                                        loadSettings();
                                        window.history.replaceState({}, document.title, "index.html");
                                        const user = JSON.parse(localStorage.getItem("user"));
                                        if (user) {
                                            document.getElementById("loginButton").textContent = "Logout";
                                            document.getElementById("loginButton").href = "#";
                                            document.getElementById("loginButton").onclick = logout;
                                        
                                            const profileButton = document.getElementById("profileButton");
                                            profileButton.innerHTML = ""; // Clear previous content
                                        
                                            // Create a span for the username
                                            const usernameSpan = document.createElement("span");
                                            name = "";
                                            if (user.displayname) {
                                                name = user.displayname;
                                            }
                                            else {
                                                name = user.username;
                                            }
                                            usernameSpan.textContent = name;
                                        
                                            // Create an avatar image
                                            const avatarIcon = document.createElement("img");
                                            avatarIcon.src = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;
                                            avatarIcon.alt = "Avatar";
                                        
                                            // Append both elements to the profile button
                                            profileButton.appendChild(usernameSpan);
                                            profileButton.appendChild(avatarIcon);
                                        }
                                    }
                                })

                                .catch(error => console.error("Error:", error));
                            }
                            // User not logged in
                            else {
                                document.getElementById("settingsButton").remove();
                            }
                        }
                        
                        async function loadTags() {
                          try {
                            const response = await fetch('https://chatcord-server.onrender.com/get-tags');
                            const tags = await response.json();
                            if (!response.ok) {
                              alert("Server is loading, come back in a minute or two!");
                            }
                        
                            const tagList = document.querySelector(".sidebar ul");
                            tagList.innerHTML = ""; // Clear previous tags

                            const excludedTags = ["Review"]; // Add tags you want to completely ignore
                        
                            const savedTagPrefs = JSON.parse(localStorage.getItem('tagPrefs') || '{}');
                        
                            tags.forEach(([tag, frequency]) => {
                              if (excludedTags.includes(tag)) return;
                              const listItem = document.createElement("li");
                        
                              // Create include checkbox
                              const includeCheckbox = document.createElement("input");
                              includeCheckbox.type = "checkbox";
                              includeCheckbox.className = "include-checkbox";
                              includeCheckbox.dataset.tag = tag;
                        
                              // Create exclude checkbox
                              const excludeCheckbox = document.createElement("input");
                              excludeCheckbox.type = "checkbox";
                              excludeCheckbox.className = "exclude-checkbox";
                              excludeCheckbox.dataset.tag = tag;
                        
                              // Apply saved preferences if available, else use default logic
                              if (tag in savedTagPrefs) {
                                includeCheckbox.checked = savedTagPrefs[tag].include || false;
                                excludeCheckbox.checked = savedTagPrefs[tag].exclude || false;
                              } else {
                                // Defaults for new users
                                if (["Male", "Female", "SFW"].includes(tag)) {
                                  includeCheckbox.checked = true;
                                }
                                if (["NSFW"].includes(tag)) {
                                  excludeCheckbox.checked = true;
                                }
                              }
                        
                              // Mutual exclusivity logic
                              includeCheckbox.addEventListener("change", () => {
                                if (includeCheckbox.checked) {
                                  excludeCheckbox.checked = false;
                                }
                                renderCharacters();
                              });
                        
                              excludeCheckbox.addEventListener("change", () => {
                                if (excludeCheckbox.checked) {
                                  includeCheckbox.checked = false;
                                }
                                renderCharacters();
                              });
                        
                              // Tag label
                              const tagLabel = document.createElement("span");
                              tagLabel.className = "tag-label";
                              tagLabel.textContent = `${tag} (${frequency})`;
                        
                              // Append elements in order
                              listItem.appendChild(includeCheckbox);
                              listItem.appendChild(tagLabel);
                              listItem.appendChild(excludeCheckbox);
                              tagList.appendChild(listItem);
                            });
                          } catch (error) {
                            console.error("Error loading tags:", error);
                          }
                        }

                        async function loadCharacters(forceRefresh = false) {
                          await fetchCharactersFromServer(forceRefresh);
                          renderCharacters();
                        }

                        async function renderCharacters() {
                          try {
                              // Work from cached data
                              const characters = [...allCharacters];
                        
                            if (characters.error) {
                              console.error('Error:', characters.error);
                              return;
                            }
                        
                            // Convert to array if needed (backend might return object)
                            const charactersArray = Array.isArray(characters) ? characters : Object.values(characters);

                            // ================================
                            // 1. RECOMMENDED CHARACTERS SECTION
                            // ================================
                            const recsCharacters = [...charactersArray] // copy array
                              .filter(char => (char.review_status || "").toLowerCase() === "approved" && !char.is_private)
                              .sort(() => Math.random() - 0.5) // shuffle randomly
                              .slice(0, 10); // take first 10
                        
                            populateGrid(recsCharacters, {
                              showDetails: true,
                              reviewMode: false,
                              accessLevel: '',
                              includeTags: getIncludeTags(),
                              excludeTags: getExcludeTags()
                            }, 'recsCharacterGrid'); // <-- specify target grid

                            // Handle URL parameters
                            const urlParamsChar = new URLSearchParams(window.location.search);
                            window.history.replaceState({}, document.title, "index.html");
                            const charID = urlParamsChar.get("charID");
                            
                            // Search setup
                            const searchInput = document.getElementById("searchBarCharacters");
                            let searchQuery = searchInput.value.toLowerCase();
                            const shouldAutoMinimize = (searchQuery || '').trim() !== '';
                            // if user is actively searching, always collapse the recommended block.
                            // otherwise restore user's saved pref (initRecsSectionState already did initial load)
                            if (shouldAutoMinimize) {
                              setRecsSectionMinimized(true, false);
                            } else {
                              // restore saved preference (in case we collapsed due to search earlier)
                              const saved = (() => { try { return localStorage.getItem(RECS_MINIMIZED_KEY); } catch (e) { return null; } })();
                              setRecsSectionMinimized(saved === '1', false);
                            }

                            // Find matching character for initial search input
                            const matchedChar = charactersArray.find(char => char.id === charID);
                            if (charID && matchedChar) {
                              searchInput.value = matchedChar.char_name;
                              searchQuery = matchedChar.char_name.toLowerCase();
                            }
                        
                            // Filter characters
                            let filteredCharacters = charactersArray.filter(char => {
                              const isApproved = (char.review_status || "").toLowerCase() === "approved";
                              const isPrivate  = char.is_private === true;
                              const matchesSearch = char.char_name?.toLowerCase().includes(searchQuery);
                              return isApproved && !isPrivate && (searchQuery === "" || matchesSearch);
                            });
                        
                            // Sorting
                            const sortOption = document.getElementById("sortOptions").value;
                            const sortOrder = document.getElementById("sortOrder").value;
                            const multiplier = sortOrder === "asc" ? -1 : 1;
                        
                            filteredCharacters.sort((charA, charB) => {
                              const getValue = (char, field) => parseInt(char[field], 10) || 0;
                              
                              switch (sortOption) {
                                case "downloads":
                                  return multiplier * (getValue(charB, 'downloads') - getValue(charA, 'downloads'));
                                case "likes":
                                  return multiplier * (getValue(charB, 'likes') - getValue(charA, 'likes'));
                                case "comments":
                                  return multiplier * (getValue(charB, 'comments') - getValue(charA, 'comments'));
                                case "favorites":
                                  return multiplier * (getValue(charB, 'favorites') - getValue(charA, 'favorites'));
                                case "date":
                                  return multiplier * (new Date(charB.createdAt) - new Date(charA.createdAt));
                                default:
                                  return 0;
                              }
                            });
                        
                            // Pass to populateGrid
                            populateGrid(filteredCharacters, {
                              showDetails: true,
                              reviewMode: false,
                              accessLevel: '',
                              includeTags: getIncludeTags(),
                              excludeTags: getExcludeTags()
                            });
                        
                          } catch (error) {
                            console.error('Error loading characters:', error);
                          }
                        }

                        function getIncludeTags() {
                            // Returns tags for which the include checkbox is checked.
                            return Array.from(document.querySelectorAll('.sidebar ul .include-checkbox:checked'))
                                .map(checkbox => checkbox.dataset.tag);
                        }

                        function getExcludeTags() {
                            // Returns tags for which the exclude checkbox is checked.
                            return Array.from(document.querySelectorAll('.sidebar ul .exclude-checkbox:checked'))
                                .map(checkbox => checkbox.dataset.tag);
                        }

                        // Logout function
                        function logout() {
                            localStorage.removeItem("user");  // Clear user data from localStorage
                            window.location.href = "index.html";  // Redirect to login page
                            document.getElementById("loginButton").textContent = "Login";
                            document.getElementById("profileButton").textContent = "Guest";
                            document.getElementById("profileButton").classList.remove("img");
                            document.getElementById("loginButton").addAttribute("href");
                            document.getElementById("loginButton").href = "https://chatcord-server.onrender.com/login";
                        }

                        document.getElementById("createCharacterButton").addEventListener("click", function (event) {
                            event.preventDefault(); // Prevent default anchor behavior
                            createCharacter();
                        });

                        document.getElementById("worldbooksButton").addEventListener("click", function (event) {
                            event.preventDefault(); // Prevent default anchor behavior
                            worldbooks();
                        });
                        
                        document.getElementById("profileButton").addEventListener("click", function (event) {
                            event.preventDefault();
                            profilePage();
                        });

                        // Add event listeners on the elements (outside of renderCharacters)
                        document.getElementById("sortOptions").addEventListener("change", renderCharacters);
                        document.getElementById("sortOrder").addEventListener("change", renderCharacters);

                        // Toggle sidebar when the hamburger menu is clicked
                        document.getElementById('menuToggle').addEventListener('click', function() {
                            const sidebar = document.querySelector('.sidebar');
                            const overlay = document.getElementById('overlay');
                            sidebar.classList.toggle('active');
                            overlay.classList.toggle('active');
                        });

                        // Mobile Header Toggle
                        document.getElementById("headerToggle").addEventListener("click", function() {
                            document.querySelector("nav").classList.toggle("active");
                            const overlay = document.getElementById('overlay');
                            overlay.classList.toggle('active');
                        });
                        
                        // Close sidebar when clicking on the overlay
                        document.getElementById('overlay').addEventListener('click', function() {
                            document.querySelector('.sidebar').classList.remove('active');
                            document.getElementById('detailsPanel')?.remove();
                            document.querySelector("nav").classList.remove('active');
                            this.classList.remove('active');
                        });

                        // Tag filtering
                        document.getElementById("searchBar").addEventListener("input", function() {
                          const filter = this.value.toLowerCase();
                          document.querySelectorAll(".sidebar li").forEach(li => {
                            // Assuming the tag name is in an element with class "tag-label"
                            const tagText = li.querySelector(".tag-label").textContent.toLowerCase();
                            li.style.display = tagText.includes(filter) ? "flex" : "none";
                          });
                        });

                        // Character grid search bar
                        document.getElementById("searchBarCharacters").addEventListener("input", renderCharacters);

                        // Settings
                        async function loadSettings() {
                            // Modal elements
                            const modal = document.getElementById('settingsModal');
                            const openSettingsBtn = document.getElementById('settingsButton');
                            const closeModal = document.getElementById('closeModal');

                            const toggleBtn = document.getElementById('toggleTagPrefsBtn');
                            const tagPrefsSection = document.getElementById('tagPrefsSection');
                            
                            toggleBtn.addEventListener('click', () => {
                                tagPrefsSection.classList.toggle('hidden');
                            });

                            document.getElementById("searchBarSettings").addEventListener("input", function () {
                                const filter = this.value.toLowerCase();
                                document.querySelectorAll("#tagPrefsSection .tag-list li").forEach(li => {
                                    const tagText = li.querySelector(".tag-label").textContent.toLowerCase();
                                    li.style.display = tagText.includes(filter) ? "flex" : "none";
                                });
                            });
                                                        
                            // Open modal when clicking settings button
                              openSettingsBtn.addEventListener('click', () => {
                                const user = JSON.parse(localStorage.getItem("user"));
                                if (user) {
                                    modal.style.display = 'block';
                                    loadTagSettings(); // Load tag preferences if needed
                                }
                                else {
                                    alert("Only logged in users can see their profile.")
                                }
                              });
                            
                              // Close modal when clicking the close button
                              closeModal.addEventListener('click', () => {
                                modal.style.display = 'none'; 
                                window.location.href = "index.html"; 
                              });
                            
                              // Close modal if clicking outside of the modal content
                              window.addEventListener('click', (event) => {
                                if (event.target === modal) {
                                  modal.style.display = 'none';
                                  window.location.href = "index.html"; 
                                }
                              });
                            
                              // Save Username functionality
                              const saveUsernameBtn = document.getElementById('saveUsername');
                              const usernameInput = document.getElementById('usernameInput');
                            
                              saveUsernameBtn.addEventListener('click', async () => {
                                const newDisplayname = usernameInput.value.trim();
                                if (newDisplayname !== '') {
                                  const existingUser = JSON.parse(localStorage.getItem('user')) || {};
                                  if (!existingUser.id) {
                                    alert("User ID not found. Please log in again.");
                                    return;
                                  }
                                    try {
                                      // Call your backend to update displayname
                                      const response = await fetch(`https://chatcord-server.onrender.com/update-displayname/${existingUser.id}`, {
                                        method: 'PUT',
                                        headers: {
                                          'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({ displayname: newDisplayname })
                                      });
                                    
                                      if (!response.ok) {
                                        const errorData = await response.json();
                                        throw new Error(errorData.description || 'Failed to update displayname');
                                      }
                                    
                                      const data = await response.json();
                                    
                                      // Update localStorage
                                      existingUser.displayname = data.user.displayname;
                                      localStorage.setItem('user', JSON.stringify(existingUser));
                                    
                                      alert('Displayname updated!');
                                    } catch (err) {
                                      console.error(err);
                                      alert(`Error: ${err.message}`);
                                    }
                                }
                              });
                            
                              // Account Deletion functionality
                              const deleteAccountBtn = document.getElementById('deleteAccount');
                              deleteAccountBtn.addEventListener('click', () => {
                                if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                                  // Clear user data from localStorage and log out user
                                  localStorage.clear();
                                  logout();
                                }
                              });

                              // Openrouter API key
                              const apiBtn = document.getElementById('openrouterKey');
                              apiBtn.addEventListener('click', () => {
                                  window.location.href = "https://openrouter.ai/auth?callback_url=https://chatcord.win/index.html"; 
                              });


                                async function loadTagSettings() {
                                  try {
                                    const response = await fetch('https://chatcord-server.onrender.com/get-tags');
                                    const tags = await response.json();
                                    const tagList = document.querySelector("#tagPrefsSection .tag-list");
                                    tagList.innerHTML = ""; // Clear existing
                                    const savedTagPrefs = JSON.parse(localStorage.getItem('tagPrefs') || '{}');

                                    tags.forEach(([tag, frequency]) => {
                                      if ( tag === "Review" ) {
                                          return;
                                      }
                                      const listItem = document.createElement("li");
                                
                                      // Include (Favorite) checkbox
                                      const includeCheckbox = document.createElement("input");
                                      includeCheckbox.type = "checkbox";
                                      includeCheckbox.className = "include-checkbox";
                                      includeCheckbox.dataset.tag = tag;
                                
                                      // Exclude (Disable) checkbox
                                      const excludeCheckbox = document.createElement("input");
                                      excludeCheckbox.type = "checkbox";
                                      excludeCheckbox.className = "exclude-checkbox";
                                      excludeCheckbox.dataset.tag = tag;

                                      // Logic: prevent both from being checked
                                      includeCheckbox.addEventListener("change", () => {
                                        if (includeCheckbox.checked) {
                                          excludeCheckbox.checked = false;
                                        }
                                      });
                                
                                      excludeCheckbox.addEventListener("change", () => {
                                        if (excludeCheckbox.checked) {
                                          includeCheckbox.checked = false;
                                        }
                                      });
                                        
                                        includeCheckbox.checked = savedTagPrefs[tag]?.include || false;
                                        excludeCheckbox.checked = savedTagPrefs[tag]?.exclude || false;

                                        function saveTagPrefs() {
                                          const allPrefs = {};
                                          document.querySelectorAll(".tag-list li").forEach(li => {
                                            const tag = li.querySelector(".include-checkbox").dataset.tag;
                                            allPrefs[tag] = {
                                              include: li.querySelector(".include-checkbox").checked,
                                              exclude: li.querySelector(".exclude-checkbox").checked
                                            };
                                          });
                                          localStorage.setItem('tagPrefs', JSON.stringify(allPrefs));
                                        }
                                        
                                        includeCheckbox.addEventListener("change", () => {
                                          if (includeCheckbox.checked) excludeCheckbox.checked = false;
                                          saveTagPrefs();
                                        });
                                        
                                        excludeCheckbox.addEventListener("change", () => {
                                          if (excludeCheckbox.checked) includeCheckbox.checked = false;
                                          saveTagPrefs();
                                        });

                                
                                      // Tag label
                                      const tagLabel = document.createElement("span");
                                      tagLabel.className = "tag-label";
                                      tagLabel.textContent = `${tag} (${frequency})`;
                                
                                      // Assemble
                                      listItem.appendChild(includeCheckbox);
                                      listItem.appendChild(tagLabel);
                                      listItem.appendChild(excludeCheckbox);
                                
                                      tagList.appendChild(listItem);
                                    });
                                  } catch (error) {
                                    console.error("Error loading tag settings:", error);
                                  }
                                }

                                const user = JSON.parse(localStorage.getItem("user"));
                                let guilds = []; // Declare in outer scope
                                
                                if (user) {
                                  const userId = user.id;
                                  try {
                                    guilds = await fetchGuilds(userId); // Assign fetched data
                                  } catch (err) {
                                    console.error("Failed to fetch guilds:", err);
                                    return;
                                  }
                                } else {
                                  alert("Please log in.");
                                  return;
                                }
                                const favoriteGuildSelect = document.getElementById("favoriteGuild");
                                // Get the stored favorite guild from localStorage (if any)
                                const favoriteGuildId = localStorage.getItem("favoriteGuildId");
                                
                                // Sort guilds to put the favorite guild at the top (if exists)
                                if (favoriteGuildId) {
                                    guilds.sort((a, b) => {
                                        // Check if a is the favorite guild
                                        if (a.guild_id === favoriteGuildId) return -1;
                                        // Check if b is the favorite guild
                                        if (b.guild_id === favoriteGuildId) return 1;
                                        return 0; // No change in order for other guilds
                                    });
                                }
                                
                                // Populate the favorite guild dropdown with the user's guilds
                                if (guilds) {
                                    guilds.forEach(guild => {
                                        const option = document.createElement("option");
                                        option.value = guild.guild_id;
                                        option.textContent = guild.name;
                                        favoriteGuildSelect.appendChild(option);
                                    });
                                }
                                // If there is a favorite guild, set it as selected
                                if (favoriteGuildId) {
                                    favoriteGuildSelect.value = favoriteGuildId;
                                }
                                
                                // Save the selected favorite guild when the user selects it
                                favoriteGuildSelect.addEventListener('change', (event) => {
                                    const selectedGuildId = event.target.value;
                                    localStorage.setItem("favoriteGuildId", selectedGuildId);
                                });
                            };

                       
                        function createCharacter() {
                            const user = JSON.parse(localStorage.getItem("user"));
                            if (user) {
                                window.location.href = "create-character.html";
                            }
                            else {
                                alert("Only logged in users can create characters.")
                            }
                        }

                        function worldbooks() {
                            window.location.href = "worldbooks.html";
                        }

                        function profilePage() {
                            const user = JSON.parse(localStorage.getItem("user"));
                            if (user) {
                                window.location.href = "profile.html";
                            }
                            else {
                                alert("Only logged in users can see their profile.")
                            }
                        }

                        async function initialize() {
                            await verifyUser();
                            await loadTags();
                            const themeToggleBtn = document.getElementById('themeToggle');
                            const themeIcon = document.getElementById('themeIcon');
                            
                            // Apply saved theme on load
                            if (localStorage.getItem('theme') === 'dark') {
                              document.body.classList.add('dark-mode');
                              themeIcon.classList.remove('fa-moon');
                              themeIcon.classList.add('fa-sun');
                            }
                            
                            // Toggle theme on click
                            themeToggleBtn.addEventListener('click', () => {
                              document.body.classList.toggle('dark-mode');
                            
                              const isDark = document.body.classList.contains('dark-mode');
                            
                              themeIcon.classList.toggle('fa-moon', !isDark);
                              themeIcon.classList.toggle('fa-sun', isDark);
                            
                              localStorage.setItem('theme', isDark ? 'dark' : 'light');
                            });

                            loadCharacters(); // Then load characters
                        }
                        initialize();
                    </script>
                </div>
        </main>
        <!-- Overlay element for mobile sidebar -->
        <div class="overlay" id="overlay"></div>
    </div>

</body>
</html>
