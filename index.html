<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatCord</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>
<body>
    <header>
        <div class="logo" id="logo">ChatCord</div>
        <nav>
            <a title="Click to go to character creator" href="PleaseEnableJavascript.html" onclick="createCharacter(); return false">Create-A-Character</a>
            <a href="#">My Bots</a>
            <a href="#" id = "profileButton">Guest</a>
            <a href="#">Subscribe</a>
            <a href="#">Rules</a>
            <a href="https://chatcord-server.onrender.com/login" id="loginButton">Login</a>
            <a href="https://discord.gg/PEWCwNAv" target="_blank">
                <img src="https://img.shields.io/badge/Join%20Discord-5865F2?style=for-the-badge&logo=discord&logoColor=white" 
                     alt="Join ChatCord">
            </a>

        </nav>
    </header>
        <div class="details-panel" id="detailsPanel">
            <img id="characterImage" src="" alt="Character">
            <div class="details-panel-like">
                <h2 id="characterName">Default Name</h2>
                <span class="favorite" id="favoriteBtn">&#x2764;</span> <!-- Heart icon for favorite -->
                <span class="thumbs-up" id="thumbsUpBtn"><i class="fas fa-thumbs-up"></i></span> <!-- Thumbs up icon -->
                <span class="thumbs-down" id="thumbsDownBtn"><i class="fas fa-thumbs-down"></i></span> <!-- Thumbs down icon -->
      </div>
            <div class="tags" id="characterTags">Tag</div>
            <p id="characterDesc">Description of the character...</p>
            <div class="details-panel-madeBy" id="details-panel-madeBy">
                <button onclick="createBot(characterName.textContent, characterImage.src, characterDesc.textContent)">Create Bot</button>
                <div class="madeBy" id="madeBy"></div>
            </div>
        </div>
    <div class="container">
        <aside class="sidebar">
            <input type="text" id="searchBar" placeholder="Search..." class="search-bar">
            <h2>Tags</h2>
            <ul id="tagFilters">
                <li><input type="checkbox" value="Female" checked> Female</li>
                <li><input type="checkbox" value="Male"> Male</li>
                <li><input type="checkbox" value="NSFW"> NSFW</li>
                <li><input type="checkbox" value="SFW" checked> SFW</li>
            </ul>
        </aside>

        <main>
                <div class="sort-controls">
                  <label for="sortOptions">Sort by:</label>
                  <select id="sortOptions">
                    <option value="downloads">Downloads</option>
                    <option value="likes">Likes</option>
                    <option value="comments">Comments</option>
                    <option value="stars">Stars</option>
                    <option value="date">Date Created</option>
                  </select>
                
                  <label for="sortOrder">Order:</label>
                  <select id="sortOrder">
                    <option value="desc">Descending</option>
                    <option value="asc">Ascending</option>
                  </select>
                </div>
            
                <div class="character-grid" id="characterGrid">
                    <script>
                        async function verifyUser() {
                            // Extract 'code' from the URL
                            const urlParams = new URLSearchParams(window.location.search);
                            const code = urlParams.get("code");
                            const user = JSON.parse(localStorage.getItem("user"));
                            
                            if (user) {
                                document.getElementById("loginButton").textContent = "Logout";
                                document.getElementById("profileButton").textContent = user.username;
                                document.getElementById("loginButton").href = "#";
                                document.getElementById("loginButton").onclick = logout;
                                document.getElementById("logo").style.backgroundImage = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;   
                            }
                            else if (code) {
                                // Send 'code' to Flask backend
                                fetch("https://chatcord-server.onrender.com/callback?code=" + code, {
                                    method: "GET",
                                    mode: "cors",
                                    credentials: "include"  // If using Flask sessions
                                })
                                .then(response => response.json())
                                .then(data => {
                                    console.log("User data:", data);
                                    if (data.user) {
                                        // Store user data in localStorage
                                        localStorage.setItem("user", JSON.stringify(data.user));
                                        window.history.replaceState({}, document.title, "/chatcord.ai/" + "index.html");
                                        const user = JSON.parse(localStorage.getItem("user"));
                                        if (user) {
                                            document.getElementById("loginButton").textContent = "Logout";
                                            document.getElementById("profileButton").textContent = user.username;
                                            document.getElementById("loginButton").href = "#";
                                            document.getElementById("loginButton").onclick = logout;
                                            document.getElementById("logo").backgroundImage = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;   
                                        }
                                    }
                                })

                                .catch(error => console.error("Error:", error));
                            }
                        }

                        async function loadTags() {
                            try {
                                const response = await fetch('https://chatcord-server.onrender.com/get-tags');
                                const tags = await response.json();
                                const tagList = document.querySelector(".sidebar ul");
                                tagList.innerHTML = ""; // Clear previous tags
                        
                                    tags.forEach(([tag, frequency]) => {  // Destructure name and count
                                        const listItem = document.createElement("li");
                                         
                                    // Create the include checkbox (left side)
                                    const includeCheckbox = document.createElement("input");
                                    includeCheckbox.type = "checkbox";
                                    includeCheckbox.className = "include-checkbox";
                                    includeCheckbox.dataset.tag = tag;
                                    // Set default state as desired (example: some tags start checked)
                                    if (["Male", "Female", "SFW"].includes(tag)) {
                                        includeCheckbox.checked = true;
                                    }
                                    includeCheckbox.addEventListener("change", () => {
                                        // If include is checked, uncheck exclude for the same tag
                                        if (includeCheckbox.checked) {
                                            excludeCheckbox.checked = false;
                                        }
                                        loadCharacters();
                                    });

                                    // Create a label for the tag text
                                    const tagLabel = document.createElement("span");
                                    tagLabel.textContent = `${tag} (${frequency})`;  // Display count next to tag name
                                    tagLabel.style.margin = "0 8px";  // spacing between checkboxes and text
                                                
                                    // Create the exclude checkbox (right side)
                                    const excludeCheckbox = document.createElement("input");
                                    excludeCheckbox.type = "checkbox";
                                    excludeCheckbox.className = "exclude-checkbox";
                                    excludeCheckbox.dataset.tag = tag;
                                    if (["NSFW"].includes(tag)) {
                                        excludeCheckbox.checked = true;
                                    }
                                    excludeCheckbox.addEventListener("change", () => {
                                        // If exclude is checked, uncheck include for the same tag
                                        if (excludeCheckbox.checked) {
                                            includeCheckbox.checked = false;
                                        }
                                        loadCharacters();
                                    });
                                    // Append the elements in order: include checkbox, tag label, then exclude checkbox with its label
                                    listItem.appendChild(includeCheckbox);
                                    listItem.appendChild(tagLabel);
                                    listItem.appendChild(excludeCheckbox);
                        
                                    tagList.appendChild(listItem);
                                });
                            } catch (error) {
                                console.error("Error loading tags:", error);
                            }
                        }

                        async function loadCharacters() {
                            try {
                                console.log("Loading characters...");  // Debugging step

                                // Fetch character data from JSON file on the server
                                const response = await fetch('https://chatcord-server.onrender.com/get-characters');
                                const characters = await response.json();
                        
                                if (characters.error) {
                                    console.error('Error:', characters.error);
                                    return;
                                }

                                // Get the selected sort option and order
                                const sortOption = document.getElementById("sortOptions").value;
                                const sortOrder = document.getElementById("sortOrder").value; // "asc" or "desc"


                                // Default sorting in our comparator is descending, so multiplier reverses it if ascending.
                                const multiplier = sortOrder === "asc" ? -1 : 1;
                                // Convert the object into an array of [id, character] pairs, then sort it
                                const sortedEntries = Object.entries(characters).sort(([idA, charA], [idB, charB]) => {
                                    let diff = 0;
                                    switch (sortOption) {
                                        case "downloads":
                                            // Convert to numbers for correct sorting
                                            diff = (parseInt(charB.stats?.downloads, 10) || 0) - (parseInt(charA.stats?.downloads, 10) || 0);
                                            break;
                                        case "likes":
                                            // Convert to numbers for correct sorting
                                            diff = (parseInt(charB.stats?.likes, 10) || 0) - (parseInt(charA.stats?.likes, 10) || 0);
                                            break;
                                        case "comments":
                                            // Convert to numbers for correct sorting
                                            diff = (parseInt(charB.stats?.comments, 10) || 0) - (parseInt(charA.stats?.comments, 10) || 0);
                                            break;
                                        case "stars":
                                            // Convert to numbers for correct sorting
                                            diff = (parseInt(charB.stats?.stars, 10) || 0) - (parseInt(charA.stats?.stars, 10) || 0);
                                            break;
                                        case "date":
                                            // Compare dates (already properly formatted ISO 8601)
                                            diff = new Date(charB.createdAt) - new Date(charA.createdAt);
                                            break;
                                        default:
                                            diff = 0;
                                    }
                                    return multiplier * diff;
                                });
                        
                                // Pass the sorted object to populateGrid
                                populateGrid(sortedEntries);
                            } catch (error) {
                                console.error('Error loading characters:', error);
                            }
                        }

                        function populateGrid(characters) {
                            const grid = document.getElementById("characterGrid");
                            grid.innerHTML = ""; // Clear existing content
                            
                            // Get filtering criteria from the two sets of checkboxes
                            const includeTags = getIncludeTags();
                            const excludeTags = getExcludeTags();

                            characters.forEach(([id, character]) => {
                                // Block character if any of its tags are in the exclusion list.
                                if (character.tags.some(tag => excludeTags.includes(tag))) {
                                    return;
                                }
                                
                                // If any include filters are active, the character must have at least one of those tags.
                                if (includeTags.length > 0 && !character.tags.some(tag => includeTags.includes(tag))) {
                                    return;
                                }
                                
                                const charDiv = document.createElement("div");
                                charDiv.classList.add("character");
                                const imageUrl = `https://chatcord-server.onrender.com/get-characters/${id}`;
                        
                                charDiv.onclick = () => showDetails(
                                    character.char_name || "Unknown Character",
                                    character.world_scenario || "No scenario available.",
                                    imageUrl,
                                    character.tags || [],
                                    character.userID,
                                    character.username,
                                    character.avatar
                                );
                                                        
                                charDiv.innerHTML = `
                                    <img class="character-img" src="${imageUrl}" alt="${character.char_name || 'Unknown'}">
                                    <p>${character.char_name || 'Unknown'}</p>
                                    <div>${character.stats.downloads || 0} ⬇ | ${character.stats.likes || 0} ❤️ | ${character.stats.stars || 0} ⭐ | ${character.stats.comments || 0} 💬</div>
                                    <div class="tags" id="characterTags"></div>
                                `;
                        
                                let characterTags = charDiv.querySelector("#characterTags");
                                const tags = Array.isArray(character.tags) ? character.tags : [];  
                                tags.forEach(tag => {
                                    let tagElement = document.createElement("span");
                                    tagElement.classList.add("tag");
                                    tagElement.textContent = tag;
                                    characterTags.appendChild(tagElement);
                                });
                                
                                grid.appendChild(charDiv);
                            });
                        }

                        function getIncludeTags() {
                            // Returns tags for which the include checkbox is checked.
                            return Array.from(document.querySelectorAll('.sidebar ul .include-checkbox:checked'))
                                .map(checkbox => checkbox.dataset.tag);
                        }

                        function getExcludeTags() {
                            // Returns tags for which the exclude checkbox is checked.
                            return Array.from(document.querySelectorAll('.sidebar ul .exclude-checkbox:checked'))
                                .map(checkbox => checkbox.dataset.tag);
                        }

                        // Logout function
                        function logout() {
                            localStorage.removeItem("user");  // Clear user data from localStorage
                            window.location.href = "index.html";  // Redirect to login page
                            document.getElementById("loginButton").textContent = "Login";
                            document.getElementById("profileButton").textContent = "Guest";
                            document.getElementById("loginButton").addAttribute("href");
                            document.getElementById("loginButton").href = "https://chatcord-server.onrender.com/login";
                            document.getElementById("logo").removeAttribute("backgroundImage");   
                        }

                        // Add event listeners on the elements (outside of loadCharacters)
                        document.getElementById("sortOptions").addEventListener("change", loadCharacters);
                        document.getElementById("sortOrder").addEventListener("change", loadCharacters);

                        function showDetails(name, desc, img, tags, ID, username, avatar) {
                            document.getElementById('characterName').innerText = name || 'Unknown Character';
                            document.getElementById('characterDesc').innerText = desc || 'No description available.';
                            document.getElementById('characterImage').src = img || 'default-image.jpg';
                        
                            const tagContainer = document.getElementById("characterTags");
                            tagContainer.innerHTML = '';  // Clear existing tags
                        
                            // Ensure tags is a valid array before looping
                            if (Array.isArray(tags)) {
                                tags.forEach(tag => {
                                    let tagElement = document.createElement("span");
                                    tagElement.classList.add("tag");
                                    tagElement.textContent = tag;
                                    tagContainer.appendChild(tagElement);
                                });
                            } else {
                                console.warn("Tags is missing or not an array:", tags);
                            }


                            const madeByDiv = document.getElementById("madeBy");
                            madeByDiv.innerHTML = `
                                <p style="margin: 0 10px;">Uploaded by <strong>${username}</strong></p>
                                <img src="https://cdn.discordapp.com/avatars/${ID}/${avatar}.png"
                                     alt="Avatar" style="width: 50px; height: 50px; border-radius: 50%;">
                            `;
                            
                        
                            document.getElementById('detailsPanel').style.display = 'block';
                        }

                        function createCharacter() {
                            const user = JSON.parse(localStorage.getItem("user"));
                            if (user) {
                                window.location.href = "create-character.html";
                            }
                            else {
                                alert("Only logged in users can create characters.")
                            }
                        }

                        // Select the heart, thumbs-up, and thumbs-down icons
                        const favoriteBtn = document.getElementById('favoriteBtn');
                        const thumbsUpBtn = document.getElementById('thumbsUpBtn');
                        const thumbsDownBtn = document.getElementById('thumbsDownBtn');
                        // Flag to track if a request is already debounced
                        let requestScheduled = false;
                        // Adding event listener for the thumbs-up button
                        favoriteBtn.addEventListener('click', () => {
                            // Check if user is logged in
                            const user = JSON.parse(localStorage.getItem("user"));
                            
                            if (!user) {
                                alert("Please log in to like characters.");
                                return;
                            }
                        
                            // Change the fav button color immediately
                            favoriteBtn.classList.toggle('filled');

                            // If no request is scheduled, debounce the request
                            if (!requestScheduled) {
                                requestScheduled = true; // Mark that a request is scheduled
                        
                                // Debounced function to execute the request after 1000ms
                                setTimeout(() => {
                                    // Perform the action here (e.g., send the request)
                                    console.log('fav executed after 1000ms');
                        
                                    // Reset the flag once the action has been executed
                                    requestScheduled = false;
                        
                                    // Example of sending a request (e.g., update like status):
                                    // updateLikeStatus(characterId, true);
                                }, 1000);
                            }
                        }, false);
                        
                        // Adding event listener for the thumbs-up button
                        thumbsUpBtn.addEventListener('click', () => {
                            // Check if user is logged in
                            const user = JSON.parse(localStorage.getItem("user"));
                            
                            if (!user) {
                                alert("Please log in to like characters.");
                                return;
                            }
                        
                            // Change the thumbs-up button color immediately
                            thumbsUpBtn.classList.toggle('active'); // Make the button red immediately
                        
                            // Remove active class from thumbs-down button if it's present
                            thumbsDownBtn.classList.remove('active');
                        
                            // If no request is scheduled, debounce the request
                            if (!requestScheduled) {
                                requestScheduled = true; // Mark that a request is scheduled
                        
                                // Debounced function to execute the request after 1000ms
                                setTimeout(() => {
                                    // Perform the action here (e.g., send the request)
                                    console.log('like executed after 1000ms');
                        
                                    // Reset the flag once the action has been executed
                                    requestScheduled = false;
                        
                                    // Example of sending a request (e.g., update like status):
                                    // updateLikeStatus(characterId, true);
                                }, 1000);
                            }
                        }, false);
                        
                        // Debounce function definition
                        function debounce(func, delay) {
                            let timer;
                            return function() {
                                if (timer) clearTimeout(timer); // Clear the previous timer if it exists
                                timer = setTimeout(() => {
                                    func.apply(this, arguments); // Execute the function after the delay
                                }, delay);
                            };
                        }
                        
                        // Adding event listener for the thumbs-up button
                        thumbsDownBtn.addEventListener('click', () => {
                            // Check if user is logged in
                            const user = JSON.parse(localStorage.getItem("user"));
                            
                            if (!user) {
                                alert("Please log in to like characters.");
                                return;
                            }
                        
                            // If no request is scheduled, debounce the request
                            if (!requestScheduled) {
                                requestScheduled = true; // Mark that a request is scheduled
                        
                                // Debounced function to execute the request after 1000ms
                                setTimeout(() => {
                                    // Perform the action here (e.g., send the request)
                                    console.log('dislike executed after 1000ms');
                        
                                    // Reset the flag once the action has been executed
                                    requestScheduled = false;
                        
                                    // Example of sending a request (e.g., update like status):
                                    // updateLikeStatus(characterId, true);
                                }, 1000);
                            }
                        }, false);
                        
                        function createBot(name, image, description) {
                            console.log("Trying to get name", name);
                            
                            var data = {
                                "username": name, // Extract text content
                                "avatar_url": image, // Extract image source
                                "content": description, // Extract text content
                                "embeds": [
                                {
                                  "title": "create",
                                  "description": image,
                                  "color": 16711680,
                                }
                                ],
                            };
                        
                            fetch("https://discord.com/api/webhooks/1352061720067309589/UONc3FvNtzfmeIygz_PFfIxpvQfkgxqTWSEdY1QB_2jada9MyIkZTQ9XRp46AzVOcZCu", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify(data)
                            })
                            .then(response => {
                                if (response.status === 204) {
                                    console.log("Success: Message sent (204 No Content)");
                                    return {}; // Return empty object to keep .json() format
                                }
                                return response.json(); // Parse only if there's content
                            })
                            .then(data => console.log("Success:", data))
                            .catch(error => console.error("Error:", error));
                        }

                        async function initialize() {
                            await verifyUser();
                            await loadTags();
                            loadCharacters(); // Then load characters
                        }
                        initialize();
                    </script>
                </div>
        </main>
    </div>

</body>
</html>
