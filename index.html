<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <h1><img src="/mascots.png" alt="Logo" class="logo"> ChatCord</h1>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="/favicon.ico">
</head>
<body>
    <header>
        <div class="header">
            <img src="/mascots.png" alt="ChatCord Logo" class="logo">
            <h1 class="title">ChatCord</h1>
        </div>
        <button class="header-toggle" id="headerToggle">â˜°</button>
        <nav>
            <a title="Click to go to character creator" id="createCharacterButton" href="#">Create-A-Character</a>
            <a title="Click to go to profile page" id="profileButton" href="#">Guest</a>
            <a title="Click to go to settings page" id="settingsButton" href="#">Settings</a>
            <a href="https://chatcord-server.onrender.com/login" id="loginButton">Login</a>
            <a href="https://discord.gg/PEWCwNAv" target="_blank">
                <img src="https://img.shields.io/badge/Join%20Discord-5865F2?style=for-the-badge&logo=discord&logoColor=white" 
                     alt="Join ChatCord">
            </a>

        </nav>
    </header>
        <div id="detailsPanelPlace">
        </div>
    <div class="container">
        <aside class="sidebar">
            <input type="text" id="searchBar" placeholder="Search..." class="search-bar">
            <h2>Tags</h2>
            <ul id="tagFilters"></ul>
        </aside>

        <main>
                <div class="sort-controls">
                    <div class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </div>
                  <select id="sortOptions">
                    <option value="downloads">Downloads</option>
                    <option value="likes">Likes</option>
                    <option value="comments">Comments</option>
                    <option value="stars">Stars</option>
                    <option value="date">Date Created</option>
                  </select>
                  <select id="sortOrder">
                    <option value="desc">Descending</option>
                    <option value="asc">Ascending</option>
                  </select>
                  <input type="text" id="searchBarCharacters" placeholder="Search..." />
                </div>
            
          <!-- Modal Settings Window -->
          <div id="settingsModal" class="modal">
            <div class="modal-content">
              <span id="closeModal" class="close">&times;</span>
              <h2>Settings</h2>
              
              <!-- Change Username -->
              <section>
                <h3>Username</h3>
                <input type="text" id="usernameInput" placeholder="Enter new username" />
                <button id="saveUsername">Save</button>
              </section>
              
              <!-- Account Deletion -->
              <section>
                <h3>Account</h3>
                <button id="deleteAccount" class="danger">Delete Account</button>
              </section>
              
              <!-- Tag Preferences -->
              <section>
                <h3>Tag Preferences</h3>
                <div id="tagSettings">
                  <!-- Populate tags dynamically similar to your loadTags() logic -->
                </div>
              </section>
              
              <!-- Optional: Theme Toggle -->
              <section>
                <h3>Theme</h3>
                <label>
                  <input type="checkbox" id="themeToggle">
                  Dark Mode
                </label>
              </section>
              
            </div>
          </div>
                <div class="character-grid" id="characterGrid">Loading characters...Check back in 1 to 2 minutes.</div>
                    <script type="module">
                        import { populateGrid } from './characterGrid.js';

                        async function verifyUser() {
                            // Extract 'code' from the URL
                            const urlParams = new URLSearchParams(window.location.search);
                            const code = urlParams.get("code");
                            const user = JSON.parse(localStorage.getItem("user"));            
                            if (user) {
                                document.getElementById("loginButton").textContent = "Logout";
                                document.getElementById("loginButton").href = "#";
                                document.getElementById("loginButton").onclick = logout;
                            
                                const profileButton = document.getElementById("profileButton");
                                profileButton.innerHTML = ""; // Clear previous content
                            
                                // Create a span for the username
                                const usernameSpan = document.createElement("span");
                                usernameSpan.textContent = user.username;
                            
                                // Create an avatar image
                                const avatarIcon = document.createElement("img");
                                avatarIcon.src = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;
                                avatarIcon.alt = "Avatar";
                            
                                // Append both elements to the profile button
                                profileButton.appendChild(usernameSpan);
                                profileButton.appendChild(avatarIcon);
                            }
                            else if (code) {
                                // Send 'code' to Flask backend
                                fetch("https://chatcord-server.onrender.com/callback?code=" + code, {
                                    method: "GET",
                                    mode: "cors",
                                    credentials: "include"  // If using Flask sessions
                                })
                                .then(response => response.json())
                                .then(data => {
                                    console.log("User data:", data);
                                    if (data.user) {
                                        // Store user data in localStorage
                                        localStorage.setItem("user", JSON.stringify(data.user));
                                        window.history.replaceState({}, document.title, "index.html");
                                        const user = JSON.parse(localStorage.getItem("user"));
                                        if (user) {
                                            document.getElementById("loginButton").textContent = "Logout";
                                            document.getElementById("loginButton").href = "#";
                                            document.getElementById("loginButton").onclick = logout;
                                        
                                            const profileButton = document.getElementById("profileButton");
                                            profileButton.innerHTML = ""; // Clear previous content
                                        
                                            // Create a span for the username
                                            const usernameSpan = document.createElement("span");
                                            usernameSpan.textContent = user.username;
                                        
                                            // Create an avatar image
                                            const avatarIcon = document.createElement("img");
                                            avatarIcon.src = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;
                                            avatarIcon.alt = "Avatar";
                                        
                                            // Append both elements to the profile button
                                            profileButton.appendChild(usernameSpan);
                                            profileButton.appendChild(avatarIcon);
                                        }
                                    }
                                })

                                .catch(error => console.error("Error:", error));
                            }
                        }

                        async function loadTags() {
                            try {
                              const response = await fetch('https://chatcord-server.onrender.com/get-tags');
                              const tags = await response.json();
                              if (!response.ok) {
                                alert("Server is loading, come back in a minute or two!");
                              }
                              const tagList = document.querySelector(".sidebar ul");
                              tagList.innerHTML = ""; // Clear previous tags
                            
                              tags.forEach(([tag, frequency]) => {
                                const listItem = document.createElement("li");
                                
                                // Create include checkbox
                                const includeCheckbox = document.createElement("input");
                                includeCheckbox.type = "checkbox";
                                includeCheckbox.className = "include-checkbox";
                                includeCheckbox.dataset.tag = tag;
                                if (["Male", "Female", "SFW"].includes(tag)) {
                                  includeCheckbox.checked = true;
                                }
                                includeCheckbox.addEventListener("change", () => {
                                  if (includeCheckbox.checked) {
                                    excludeCheckbox.checked = false;
                                  }
                                  loadCharacters();
                                });
                            
                                // Create the tag label
                                const tagLabel = document.createElement("span");
                                tagLabel.className = "tag-label";
                                tagLabel.textContent = `${tag} (${frequency})`;
                            
                                // Create exclude checkbox
                                const excludeCheckbox = document.createElement("input");
                                excludeCheckbox.type = "checkbox";
                                excludeCheckbox.className = "exclude-checkbox";
                                excludeCheckbox.dataset.tag = tag;
                                if (["NSFW"].includes(tag)) {
                                  excludeCheckbox.checked = true;
                                }
                                excludeCheckbox.addEventListener("change", () => {
                                  if (excludeCheckbox.checked) {
                                    includeCheckbox.checked = false;
                                  }
                                  loadCharacters();
                                });
                            
                                // Append elements in order
                                listItem.appendChild(includeCheckbox);
                                listItem.appendChild(tagLabel);
                                listItem.appendChild(excludeCheckbox);
                            
                                tagList.appendChild(listItem);
                              });
                            } catch (error) {
                              console.error("Error loading tags:", error);
                            }
                        }

                        async function loadCharacters() {
                            try {
                                // Fetch character data from JSON file on the server
                                const response = await fetch('https://chatcord-server.onrender.com/get-characters');
                                const characters = await response.json();
                        
                                if (characters.error) {
                                    console.error('Error:', characters.error);
                                    return;
                                }

                                // Get the search query and convert it to lowercase for case-insensitive matching
                                const searchQuery = document.getElementById("searchBarCharacters").value.toLowerCase();
                                const filteredCharacters = Object.entries(characters).filter(([id, char]) => 
                                    searchQuery === "" || char.char_name.toLowerCase().includes(searchQuery)
                                );

                                // Get the selected sort option and order
                                const sortOption = document.getElementById("sortOptions").value;
                                const sortOrder = document.getElementById("sortOrder").value; // "asc" or "desc"


                                // Default sorting in our comparator is descending, so multiplier reverses it if ascending.
                                const multiplier = sortOrder === "asc" ? -1 : 1;
                                // Convert the object into an array of [id, character] pairs, then sort it
                                const sortedEntries = filteredCharacters.sort(([idA, charA], [idB, charB]) => {
                                    let diff = 0;
                                    switch (sortOption) {
                                        case "downloads":
                                            // Convert to numbers for correct sorting
                                            diff = (parseInt(charB.stats?.downloads, 10) || 0) - (parseInt(charA.stats?.downloads, 10) || 0);
                                            break;
                                        case "likes":
                                            // Convert to numbers for correct sorting
                                            diff = (parseInt(charB.stats?.likes, 10) || 0) - (parseInt(charA.stats?.likes, 10) || 0);
                                            break;
                                        case "comments":
                                            // Convert to numbers for correct sorting
                                            diff = (parseInt(charB.stats?.comments, 10) || 0) - (parseInt(charA.stats?.comments, 10) || 0);
                                            break;
                                        case "stars":
                                            // Convert to numbers for correct sorting
                                            diff = (parseInt(charB.stats?.stars, 10) || 0) - (parseInt(charA.stats?.stars, 10) || 0);
                                            break;
                                        case "date":
                                            // Compare dates (already properly formatted ISO 8601)
                                            diff = new Date(charB.createdAt) - new Date(charA.createdAt);
                                            break;
                                        default:
                                            diff = 0;
                                    }
                                    return multiplier * diff;
                                });
                        
                                // Pass the sorted object to populateGrid
                                populateGrid(sortedEntries, getIncludeTags(), getExcludeTags(), true);
                            } catch (error) {
                                console.error('Error loading characters:', error);
                            }
                        }

                        function getIncludeTags() {
                            // Returns tags for which the include checkbox is checked.
                            return Array.from(document.querySelectorAll('.sidebar ul .include-checkbox:checked'))
                                .map(checkbox => checkbox.dataset.tag);
                        }

                        function getExcludeTags() {
                            // Returns tags for which the exclude checkbox is checked.
                            return Array.from(document.querySelectorAll('.sidebar ul .exclude-checkbox:checked'))
                                .map(checkbox => checkbox.dataset.tag);
                        }

                        // Logout function
                        function logout() {
                            localStorage.removeItem("user");  // Clear user data from localStorage
                            window.location.href = "index.html";  // Redirect to login page
                            document.getElementById("loginButton").textContent = "Login";
                            document.getElementById("profileButton").textContent = "Guest";
                            document.getElementById("profileButton").classList.remove("img");
                            document.getElementById("loginButton").addAttribute("href");
                            document.getElementById("loginButton").href = "https://chatcord-server.onrender.com/login";
                        }

                        document.getElementById("createCharacterButton").addEventListener("click", function (event) {
                            event.preventDefault(); // Prevent default anchor behavior
                            createCharacter();
                        });
                        
                        document.getElementById("profileButton").addEventListener("click", function (event) {
                            event.preventDefault();
                            profilePage();
                        });

                        // Add event listeners on the elements (outside of loadCharacters)
                        document.getElementById("sortOptions").addEventListener("change", loadCharacters);
                        document.getElementById("sortOrder").addEventListener("change", loadCharacters);

                        // Toggle sidebar when the hamburger menu is clicked
                        document.getElementById('menuToggle').addEventListener('click', function() {
                            const sidebar = document.querySelector('.sidebar');
                            const overlay = document.getElementById('overlay');
                            sidebar.classList.toggle('active');
                            overlay.classList.toggle('active');
                        });

                        // Mobile Header Toggle
                        document.getElementById("headerToggle").addEventListener("click", function() {
                            document.querySelector("nav").classList.toggle("active");
                            const overlay = document.getElementById('overlay');
                            overlay.classList.toggle('active');
                        });
                        
                        // Close sidebar when clicking on the overlay
                        document.getElementById('overlay').addEventListener('click', function() {
                            document.querySelector('.sidebar').classList.remove('active');
                            document.getElementById('detailsPanel')?.remove();
                            document.querySelector("nav").classList.remove('active');
                            this.classList.remove('active');
                        });

                        // Tag filtering
                        document.getElementById("searchBar").addEventListener("input", function() {
                          const filter = this.value.toLowerCase();
                          document.querySelectorAll(".sidebar li").forEach(li => {
                            // Assuming the tag name is in an element with class "tag-label"
                            const tagText = li.querySelector(".tag-label").textContent.toLowerCase();
                            li.style.display = tagText.includes(filter) ? "flex" : "none";
                          });
                        });

                        // Character grid search bar
                        document.getElementById("searchBarCharacters").addEventListener("input", loadCharacters);

                        // Settings
                        document.addEventListener('DOMContentLoaded', () => {
                              // Modal elements
                              const modal = document.getElementById('settingsModal');
                              const openSettingsBtn = document.getElementById('settingsButton');
                              const closeModal = document.getElementById('closeModal');
                            
                              // Open modal when clicking settings button
                              openSettingsBtn.addEventListener('click', () => {
                                modal.style.display = 'block';
                                loadTagSettings(); // Load tag preferences if needed
                              });
                            
                              // Close modal when clicking the close button
                              closeModal.addEventListener('click', () => {
                                modal.style.display = 'none';
                              });
                            
                              // Close modal if clicking outside of the modal content
                              window.addEventListener('click', (event) => {
                                if (event.target === modal) {
                                  modal.style.display = 'none';
                                }
                              });
                            
                              // Save Username functionality
                              const saveUsernameBtn = document.getElementById('saveUsername');
                              const usernameInput = document.getElementById('usernameInput');
                              saveUsernameBtn.addEventListener('click', () => {
                                if (usernameInput.value.trim() !== '') {
                                  localStorage.setItem('user', JSON.stringify({ username: usernameInput.value.trim() }));
                                  alert('Username updated!');
                                }
                              });
                            
                              // Account Deletion functionality
                              const deleteAccountBtn = document.getElementById('deleteAccount');
                              deleteAccountBtn.addEventListener('click', () => {
                                if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                                  // Clear user data from localStorage and perform any additional cleanup
                                  logout();
                                }
                              });
                            
                              // Theme Toggle functionality (example)
                              const themeToggle = document.getElementById('themeToggle');
                              themeToggle.addEventListener('change', () => {
                                if (themeToggle.checked) {
                                  document.body.classList.add('dark-mode');
                                } else {
                                  document.body.classList.remove('dark-mode');
                                }
                              });
                              
                              // Example: Function to load tag preferences similar to loadTags()
                              async function loadTagSettings() {
                                try {
                                  const response = await fetch('https://chatcord-server.onrender.com/get-tags');
                                  const tags = await response.json();
                                  const tagSettingsContainer = document.getElementById('tagSettings');
                                  tagSettingsContainer.innerHTML = "";
                                  
                                  tags.forEach(([tag, frequency]) => {
                                    const div = document.createElement("div");
                                    div.className = "tag-setting";
                                    div.innerHTML = `
                                      <label>
                                        <input type="checkbox" class="include-checkbox" data-tag="${tag}">
                                        Favorite
                                      </label>
                                      <span>${tag} (${frequency})</span>
                                      <label>
                                        <input type="checkbox" class="exclude-checkbox" data-tag="${tag}">
                                        Disable
                                      </label>
                                    `;
                                    // Optionally add listeners to save these preferences in localStorage or send to the server
                                    tagSettingsContainer.appendChild(div);
                                  });
                                } catch (error) {
                                  console.error("Error loading tag settings:", error);
                                }
                              }
                            });

                       
                        function createCharacter() {
                            const user = JSON.parse(localStorage.getItem("user"));
                            if (user) {
                                window.location.href = "create-character.html";
                            }
                            else {
                                alert("Only logged in users can create characters.")
                            }
                        }

                        function profilePage() {
                            const user = JSON.parse(localStorage.getItem("user"));
                            if (user) {
                                window.location.href = "profile.html";
                            }
                            else {
                                alert("Only logged in users can see their profile.")
                            }
                        }

                        async function initialize() {
                            await verifyUser();
                            await loadTags();
                            loadCharacters(); // Then load characters
                        }
                        initialize();
                    </script>
                </div>
        </main>
        <!-- Overlay element for mobile sidebar -->
        <div class="overlay" id="overlay"></div>
    </div>

</body>
</html>
